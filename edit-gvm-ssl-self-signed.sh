#!/bin/bash
###################################################################################
# Change parameters for GVM Self signed SSL certificates to extend lifetime and fix CN mismatch
# Works on GVM 20 | 21  Ubuntu 20.04.4 / Debian / Raspian Bullseye
# David Harrop 
# June 2022
# Usage:
# Run this script to edit GVM's ssl update tool
# (Change thee below to suit very carefully as sed lauguage with \ char is fickle)
# then run sudo ./gvm-manage-certs -a -f to update SSL certs
#####################################################################################
clear
##########################

# Color variables
red='\033[1;31m'
green='\033[1;32m'
yellow='\033[1;33m'
blue='\033[1;34m'
cyan='\033[1;36m'
purple='\033[1;35m'  
clear='\033[0m'

# Get IPv4 address
ipa=$(ip -o addr show up primary scope global |
      while read -r num dev fam addr rest; do echo ${addr%/*}; done)

# Ask for scanner's admin site name to match ssl cert DNS name 
while true
do
	echo -e "${GREEN}"  
	read -p "Enter scanner admin site FULL DNS NAME e.g. name.yourdomain.lan  : " website
	echo 	
    break
    echo -e "${NC}"
done

### Edit below carefully ###

sudo sed -i 's/{GVM_CERTIFICATE_LIFETIME:-730}/{GVM_CERTIFICATE_LIFETIME:-36135}/g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/GVM_CERTIFICATE_COUNTRY:-"DE"/GVM_CERTIFICATE_COUNTRY:-"AU"/g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/GVM_CERTIFICATE_STATE:-""/GVM_CERTIFICATE_STATE:-"VIC"/g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/GVM_CERTIFICATE_LOCALITY:-"Osnabrueck"/GVM_CERTIFICATE_LOCALITY:-"Melbourne"/g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/GVM_CERTIFICATE_ORG_UNIT:-""/GVM_CERTIFICATE_ORG_UNIT:-"Pax8 Academy"/g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/GVM_CERTIFICATE_SAN_DNS:-""/GVM_CERTIFICATE_SAN_DNS:-"'$website'" /g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/GVM_CERTIFICATE_SAN_IP_ADDRESS:-""/GVM_CERTIFICATE_SAN_IP_ADDRESS:-"'$ipa'"/g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i '/echo "crl_signing_key"/a echo "cn = $GVM_CA_CERTIFICATE_SAN_DNS" >> $GVM_CERT_TEMPLATE_FILENAME' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/cn = \\"$GVM_CERTIFICATE_HOSTNAME\\""/cn = \\"$GVM_CA_CERTIFICATE_SAN_DNS\\""/g' /opt/gvm/bin/gvm-manage-certs
sudo sed -i 's/cn = \\"$GVM_CA_CERTIFICATE_HOSTNAME\\""/cn = \\"$GVM_CA_CERTIFICATE_SAN_DNS\\""/g' /opt/gvm/bin/gvm-manage-certs
 
 
#############################
#Restart services 
sudo service gsa restart
sudo service gvm restart

##Show current certificate date ranges
echo -e "Current certificate expiry info. run sudo ./gvm-manage-certs -a -f to re-issue."
cat /opt/gvm/var/lib/gvm/CA/cacert.pem | openssl x509 -noout -dates 
cat /opt/gvm/var/lib/gvm/CA/servercert.pem | openssl x509 -noout -dates
cat /opt/gvm/var/lib/gvm/CA/clientcert.pem | openssl x509 -noout -dates

sudo ./gvm-manage-certs
